{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import process from\"node:process\";import{TranscodeJobStatus}from\"@prisma/client\";import mediaTranscodeModule from\"../../lib/queues/mediaTranscode.queue\";import prismaModule from\"../../lib/prisma\";const{createMediaTranscodeQueue}=mediaTranscodeModule;const{prisma}=prismaModule;const MAX_WAITING_JOBS=100;const MAX_FAILED_JOBS_LAST_HOUR=5;const LOOKBACK_MINUTES=60;const run=__name(async()=>{const queue=createMediaTranscodeQueue();try{const counts=await queue.getJobCounts(\"waiting\",\"delayed\",\"failed\");const waiting=counts.waiting??0;const delayed=counts.delayed??0;const failed=counts.failed??0;const failedLastHour=await prisma.transcodeJob.count({where:{status:TranscodeJobStatus.failed,finishedAt:{gte:new Date(Date.now()-LOOKBACK_MINUTES*6e4)}}});if(waiting>MAX_WAITING_JOBS||failedLastHour>MAX_FAILED_JOBS_LAST_HOUR){const issue={waiting,delayed,failed,failedLastHour};console.error(`ALERT media.pipeline issue=${JSON.stringify(issue)}`);process.exitCode=1}else{console.log(`OK media.pipeline waiting=${waiting} delayed=${delayed} failed=${failed} failedLastHour=${failedLastHour}`)}}finally{await prisma.$disconnect();await queue.close()}},\"run\");run().catch(error=>{console.error(\"ALERT media.pipeline fatal\",error);process.exitCode=1});\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,OAAO,YAAa,eAEpB,OAAS,uBAA0B,iBAEnC,OAAO,yBAA0B,wCACjC,OAAO,iBAAkB,mBAGzB,KAAM,CAAE,yBAA0B,EAAI,qBAEtC,KAAM,CAAE,MAAO,EAAI,aAEnB,MAAM,iBAAmB,IACzB,MAAM,0BAA4B,EAClC,MAAM,iBAAmB,GAEzB,MAAM,IAAM,gBAAY,CACtB,MAAM,MAAQ,0BAA0B,EACxC,GAAI,CACF,MAAM,OAAS,MAAM,MAAM,aAAa,UAAW,UAAW,QAAQ,EACtE,MAAM,QAAU,OAAO,SAAW,EAClC,MAAM,QAAU,OAAO,SAAW,EAClC,MAAM,OAAS,OAAO,QAAU,EAChC,MAAM,eAAiB,MAAM,OAAO,aAAa,MAAM,CACrD,MAAO,CACL,OAAQ,mBAAmB,OAC3B,WAAY,CACV,IAAK,IAAI,KAAK,KAAK,IAAI,EAAI,iBAAmB,GAAM,CACtD,CACF,CACF,CAAC,EACD,GAAI,QAAU,kBAAoB,eAAiB,0BAA2B,CAC5E,MAAM,MAAQ,CAAE,QAAS,QAAS,OAAQ,cAAe,EACzD,QAAQ,MAAM,8BAA8B,KAAK,UAAU,KAAK,CAAC,EAAE,EACnE,QAAQ,SAAW,CACrB,KAAO,CACL,QAAQ,IACN,6BAA6B,OAAO,YAAY,OAAO,WAAW,MAAM,mBAAmB,cAAc,EAC3G,CACF,CACF,QAAE,CACA,MAAM,OAAO,YAAY,EACzB,MAAM,MAAM,MAAM,CACpB,CACF,EA5BY,OA8BZ,IAAI,EAAE,MAAO,OAAU,CACrB,QAAQ,MAAM,6BAA8B,KAAK,EACjD,QAAQ,SAAW,CACrB,CAAC","names":[],"ignoreList":[],"sources":["/Users/arminiranpour/Desktop/Project/CNaghsh-next/apps/web/scripts/media/alert-check.mts"],"sourcesContent":[null]}}