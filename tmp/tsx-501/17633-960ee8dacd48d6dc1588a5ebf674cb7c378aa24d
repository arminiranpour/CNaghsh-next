{"code":"__filename=\"/Users/arminiranpour/Desktop/Project/CNaghsh-next/apps/web/lib/media/health.ts\";(()=>{\n\"use strict\";var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var health_exports={};__export(health_exports,{getMediaHealth:()=>getMediaHealth});module.exports=__toCommonJS(health_exports);var import_client=require(\"@prisma/client\");var import_prisma=require(\"@/lib/prisma\");var import_mediaTranscode=require(\"@/lib/queues/mediaTranscode.queue\");const getMediaHealth=__name(async(options={})=>{const prisma=options.prismaClient??import_prisma.prisma;const lookbackMinutes=options.lookbackMinutes??60;const lookbackDate=new Date(Date.now()-lookbackMinutes*6e4);const queue=(0,import_mediaTranscode.createMediaTranscodeQueue)();try{const counts=await queue.getJobCounts(\"waiting\",\"active\",\"delayed\",\"failed\");const completedLastHour=await prisma.transcodeJob.count({where:{status:import_client.TranscodeJobStatus.done,finishedAt:{gte:lookbackDate}}});const[readyVideos,failedVideos,processingVideos,pendingModeration,failedJobs]=await Promise.all([prisma.mediaAsset.count({where:{type:import_client.MediaType.video,status:import_client.MediaStatus.ready}}),prisma.mediaAsset.count({where:{type:import_client.MediaType.video,status:import_client.MediaStatus.failed}}),prisma.mediaAsset.count({where:{type:import_client.MediaType.video,status:import_client.MediaStatus.processing}}),prisma.mediaAsset.count({where:{type:import_client.MediaType.video,moderationStatus:import_client.MediaModerationStatus.pending}}),prisma.transcodeJob.findMany({where:{status:import_client.TranscodeJobStatus.failed},orderBy:[{finishedAt:\"desc\"},{createdAt:\"desc\"}],take:10,select:{mediaAssetId:true,finishedAt:true,mediaAsset:{select:{status:true,errorMessage:true}}}})]);return{queue:{waiting:counts.waiting??0,active:counts.active??0,delayed:counts.delayed??0,failed:counts.failed??0,completedLastHour},database:{readyVideos,failedVideos,processingVideos,pendingModeration},recentFailures:failedJobs.map(job=>({mediaId:job.mediaAssetId,status:job.mediaAsset?.status??\"unknown\",errorMessage:job.mediaAsset?.errorMessage??null,failedAt:job.finishedAt?job.finishedAt.toISOString():null}))}}finally{await queue.close()}},\"getMediaHealth\");0&&(module.exports={getMediaHealth});\n})()\n","warnings":[],"map":{"version":3,"mappings":";mvBAAA,iJAAqG,0BAErG,kBAAwC,wBACxC,0BAA0C,6CA6BnC,MAAM,eAAiB,aAAO,QAAyB,CAAC,IAAoC,CACjG,MAAM,OAAS,QAAQ,cAAgB,cAAAA,OACvC,MAAM,gBAAkB,QAAQ,iBAAmB,GACnD,MAAM,aAAe,IAAI,KAAK,KAAK,IAAI,EAAI,gBAAkB,GAAM,EAEnE,MAAM,SAAQ,iDAA0B,EACxC,GAAI,CACF,MAAM,OAAS,MAAM,MAAM,aAAa,UAAW,SAAU,UAAW,QAAQ,EAChF,MAAM,kBAAoB,MAAM,OAAO,aAAa,MAAM,CACxD,MAAO,CACL,OAAQ,iCAAmB,KAC3B,WAAY,CACV,IAAK,YACP,CACF,CACF,CAAC,EAED,KAAM,CAAC,YAAa,aAAc,iBAAkB,kBAAmB,UAAU,EAAI,MAAM,QAAQ,IAAI,CACrG,OAAO,WAAW,MAAM,CACtB,MAAO,CAAE,KAAM,wBAAU,MAAO,OAAQ,0BAAY,KAAM,CAC5D,CAAC,EACD,OAAO,WAAW,MAAM,CACtB,MAAO,CAAE,KAAM,wBAAU,MAAO,OAAQ,0BAAY,MAAO,CAC7D,CAAC,EACD,OAAO,WAAW,MAAM,CACtB,MAAO,CAAE,KAAM,wBAAU,MAAO,OAAQ,0BAAY,UAAW,CACjE,CAAC,EACD,OAAO,WAAW,MAAM,CACtB,MAAO,CAAE,KAAM,wBAAU,MAAO,iBAAkB,oCAAsB,OAAQ,CAClF,CAAC,EACD,OAAO,aAAa,SAAS,CAC3B,MAAO,CAAE,OAAQ,iCAAmB,MAAO,EAC3C,QAAS,CAAC,CAAE,WAAY,MAAO,EAAG,CAAE,UAAW,MAAO,CAAC,EACvD,KAAM,GACN,OAAQ,CACN,aAAc,KACd,WAAY,KACZ,WAAY,CACV,OAAQ,CACN,OAAQ,KACR,aAAc,IAChB,CACF,CACF,CACF,CAAC,CACH,CAAC,EAED,MAAO,CACL,MAAO,CACL,QAAS,OAAO,SAAW,EAC3B,OAAQ,OAAO,QAAU,EACzB,QAAS,OAAO,SAAW,EAC3B,OAAQ,OAAO,QAAU,EACzB,iBACF,EACA,SAAU,CACR,YACA,aACA,iBACA,iBACF,EACA,eAAgB,WAAW,IAAK,MAAS,CACvC,QAAS,IAAI,aACb,OAAQ,IAAI,YAAY,QAAU,UAClC,aAAc,IAAI,YAAY,cAAgB,KAC9C,SAAU,IAAI,WAAa,IAAI,WAAW,YAAY,EAAI,IAC5D,EAAE,CACJ,CACF,QAAE,CACA,MAAM,MAAM,MAAM,CACpB,CACF,EAvE8B","names":["defaultPrisma"],"ignoreList":[],"sources":["/Users/arminiranpour/Desktop/Project/CNaghsh-next/apps/web/lib/media/health.ts"],"sourcesContent":[null]}}