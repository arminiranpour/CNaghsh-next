# سناریوهای QA فاز فاکتور و رسید

## شماره‌گذاری و بازشماری
1. دو پرداخت متوالی در یک روز انجام دهید؛ انتظار می‌رود شماره‌ها به صورت `INV-YYYYMMDD-0001` و `INV-YYYYMMDD-0002` ثبت شوند.
2. با اجرای اکشن «بازشماری شماره» در پنل ادمین برای یک فاکتور، بررسی کنید شماره جدید بدون تداخل صادر شود و در داشبورد کاربر نیز دیده شود.

## دسترسی PDF
1. از داشبورد کاربر روی «دانلود PDF» کلیک کنید؛ فایل باید با جهت راست‌به‌چپ، تاریخ شمسی و مبالغ ریالی باز شود.
2. تلاش کنید لینک دانلود فاکتور کاربر دیگر را باز کنید؛ باید 403 دریافت شود.
3. برای فاکتورهای پرداخت‌شده، با ابزار شبکه مرورگر هدر `Cache-Control` را بررسی کنید (باید `public, max-age=3600` باشد).

## وضعیت‌ها و واترمارک
1. فاکتور پرداخت‌شده را مشاهده کنید؛ نباید واترمارک داشته باشد.
2. فاکتور استرداد و ابطال‌شده را دانلود کنید؛ باید واترمارک‌های «REFUNDED» و «VOID» را نمایش دهند.
3. پیش‌فاکتور صادر کنید (قبل از پرداخت) و PDF را مشاهده کنید؛ واترمارک «DRAFT» و یادداشت توضیحی باید وجود داشته باشد.

## آیتم‌ها و مبالغ
1. در PDF دوره پوشش باید با تاریخ شروع/پایان اشتراک همخوانی داشته باشد.
2. برای فاکتور استرداد، مبالغ واحد و جمع خط باید منفی باشند.

## عملیات مدیریتی
1. در `/admin/billing/invoices` فاکتورها را بر اساس وضعیت، نوع و تاریخ فیلتر کنید و مطمئن شوید فهرست به‌روز می‌شود.
2. با اکشن «ابطال» فاکتور، وضعیت باید به `VOID` تغییر کند و دلیل در ستون یادداشت ذخیره شود.
3. اکشن‌ها باید لاگ ممیزی ثبت کنند (در جدول Audit قابل بررسی است).

## اعلان ایمیلی (در صورت فعال بودن SMTP)
1. پس از صدور فاکتور فروش، ایمیل اطلاع‌رسانی باید حاوی لینک PDF باشد.
2. پس از ثبت استرداد، ایمیل توضیحی همراه با لینک PDF ارسال می‌شود.
