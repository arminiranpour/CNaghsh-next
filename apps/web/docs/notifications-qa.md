# چک‌لیست QA اعلان‌های صورتحساب

## پیش‌نیازها
- اجرای `pnpm --filter @app/web prisma migrate dev` و داشتن داده‌ی نمونه اشتراک/پرداخت.
- مقداردهی `NOTIFICATIONS_SECRET` و `PUBLIC_BASE_URL` و راه‌اندازی Mailhog برای مشاهده‌ی ایمیل‌ها.
- فعال بودن کران `POST /api/internal/cron/notifications` یا اجرای دستی آن برای پردازش صف.

## سناریوهای ضروری
1. **تمدید موفق اشتراک**
   - یک تمدید را از صفحه‌ی ادمین یا اسکریپت آزمایشی انجام دهید.
   - انتظار: ایمیل با عنوان «تمدید اشتراک شما با موفقیت انجام شد» و اعلان درون‌برنامه ایجاد شود؛ تاریخ پایان جدید باید به صورت جلالی نمایش داده شود.
   - در صفحه‌ی ادمین اعلان‌ها وضعیت `SENT` و شناسه فاکتور/کاربر صحیح باشد.

2. **یادآوری سه روز مانده**
   - تاریخ پایان اشتراک را سه روز بعد تنظیم کنید و کران اعلان‌ها را اجرا کنید.
   - انتظار: ایمیل یادآوری با دکمه «تمدید اکنون» و بنر در داشبورد نمایش داده شود. هیچ تکراری در ۲۴ ساعت رخ ندهد (دوباره کران را اجرا کنید و مطمئن شوید یادآوری جدیدی ثبت نشده است).

3. **انقضا و حذف دسترسی**
   - اشتراک را منقضی کنید (`SubscriptionStatus` را `expired`).
   - انتظار: ایمیل «اشتراک شما منقضی شد»، بنر حذف دسترسی و اعلان درون‌برنامه ثبت شوند.

4. **پرداخت ناموفق**
   - یک پرداخت را در حالت `FAILED` قرار دهید یا وب‌هوک شکست را بازپخش کنید.
   - انتظار: ایمیل «پرداخت ناموفق بود» بدون نمایش اطلاعات حساس، بنر تلاش مجدد و اعلان درون‌برنامه. صفحه ادمین اعلان‌ها باید خطای سرویس ایمیل را در ستون `error` نشان دهد اگر ارسال ناموفق شد.

5. **بازپرداخت**
   - بازپرداخت کامل یا جزئی را ثبت کنید.
   - انتظار: ایمیل با مقدار منفی ریال و لینک PDF بازپرداخت، اعلان درون‌برنامه با سیاست دسترسی.

6. **لغو فوری / لغو در پایان دوره**
   - لغو فوری را از ادمین و لغو در پایان دوره را از داشبورد کاربر انجام دهید.
   - انتظار: دو قالب ایمیل متفاوت، بنر‌های داشبورد مطابق وضعیت، و قابلیت لغو درخواست لغو (در صورت مجاز) بدون نمایش بنر.

7. **رسید نهایی**
   - صدور فاکتور فروش یا بازپرداخت را شبیه‌سازی کنید.
   - انتظار: ایمیل «رسید پرداخت شما آماده است» و لینک دانلود PDF که با شماره فاکتور مطابق سیاست فاز ۷ باشد.

8. **اولویت اعلان‌ها**
   - از صفحه داشبورد و لینک امضاشده مدیریت اعلان، دسته‌ی یادآوری‌ها را غیرفعال کنید.
   - اجرای کران یادآوری نباید ایمیل جدیدی ارسال کند؛ پیام لاگ باید `SKIPPED` باشد.

9. **ایمن بودن تکرار**
   - یک رویداد را دوباره ارسال کنید (همان `dedupeKey`).
   - انتظار: در صفحه ادمین اعلان‌ها فقط یک رکورد با وضعیت `duplicate` برای تلاش جدید ثبت شود.

10. **قابلیت دسترس‌پذیری و راست‌به‌چپ**
    - قالب ایمیل و اعلان‌ها را با صفحه‌خوان بررسی کنید؛ دکمه‌ها باید با کیبورد قابل استفاده باشند و متن‌ها به صورت RTL نمایش داده شوند.

11. **مدیریت خطا**
    - ارسال ایمیل را با بازگرداندن خطای موقتی شبیه‌سازی کنید.
    - انتظار: سه تلاش با افزایش زمان انتظار، سپس وضعیت `FAILED` در جدول و صفحه ادمین نمایش داده شود.

## گزارش‌گیری
- نتایج هر سناریو را در QA Report اصلی (docs/qa.md) مستند کنید.
- هر مشکل را با شناسه `NOTIFY-<شماره>` در تیکت ترکینگ ثبت و به تیم صورتحساب اطلاع دهید.
