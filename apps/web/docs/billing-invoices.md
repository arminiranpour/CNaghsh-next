# راهنمای فاکتور و رسید

این سند خلاصه‌ای از نحوه مدیریت فاکتورها و رسیدهای سامانه است.

## وضعیت‌ها و شماره‌گذاری

- فاکتورهای فروش در زمان موفقیت پرداخت با قالب `INV-YYYYMMDD-XXXX` شماره‌گذاری می‌شوند؛ چهار رقم انتهایی شمارنده روز هستند.
- فاکتورهای استرداد (Refund) نیز شماره‌ی مستقل دارند و به فاکتور اصلی ارجاع می‌دهند.
- پیش‌فاکتور و فاکتورهای باطل‌شده شماره جدید دریافت نمی‌کنند؛ در صورت نیاز می‌توان از ابزار «بازشماری شماره» در پنل ادمین استفاده کرد.

## دسترسی به PDF

- لینک `/api/invoices/[invoiceId]/pdf` تنها برای صاحب حساب یا مدیر سیستم قابل استفاده است.
- فاکتورهای قطعی (پرداخت‌شده، استرداد، باطل‌شده) با هدر کش عمومی یک‌ساعته سرو می‌شوند. پیش‌فاکتور‌ها همیشه `no-store` هستند.
- همه فایل‌ها با فونت فارسی، جهت راست‌به‌چپ، تاریخ شمسی و مبالغ ریالی رندر می‌شوند.

## داده‌های نمایش داده شده

- سرصفحه شامل برند شرکت، شناسه اقتصادی و اطلاعات تماس است.
- بلوک «صورتحساب به نام» نام، ایمیل و شناسه کاربر را نمایش می‌دهد.
- جدول آیتم‌ها پلن، دوره پوشش، تعداد، قیمت واحد و جمع خط را نشان می‌دهد. برای استرداد مبالغ منفی هستند.
- بخش جمع کل همیشه ستون‌های جمع جزء، تخفیف، مالیات و جمع کل را نشان می‌دهد؛ فعلاً تخفیف و مالیات صفر هستند.
- بر اساس وضعیت، واترمارک «DRAFT»، «VOID» یا «REFUNDED» روی صفحه قرار می‌گیرد.

## عملیات مدیریتی

- **دانلود PDF**: برای همه وضعیت‌ها به جز پیش‌فاکتور فعال است.
- **بازشماری شماره**: در صورت بروز مشکل شمارنده روز یا پس از اصلاح دستی داده‌ها قابل استفاده است.
- **ابطال فاکتور**: وضعیت را به باطل‌شده تغییر می‌دهد و دلیل ثبت شده در یادداشت ذخیره می‌شود.

## اعلان‌ها

- پس از صدور فاکتور فروش یا استرداد، ایمیل اطلاع‌رسانی به کاربر ارسال می‌شود (در محیط توسعه در صورت فعال بودن SMTP).

## مسیرهای مفید

- داشبورد کاربر: `/dashboard/billing` – امکان دانلود PDF از جدول فاکتورها.
- پنل مدیریت فاکتورها: `/admin/billing/invoices` – فیلتر، دانلود و عملیات کنترلی.
