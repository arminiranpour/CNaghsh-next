# راهنمای عملیاتی اعلان‌ها

## نمای کلی
این سرویس ارسال اعلان‌ها برای رویدادهای صورتحساب، ایمیل و اعلان درون‌برنامه را به صورت ایمن و غیرتکراری مدیریت می‌کند. همه پیام‌ها در جدول `NotificationMessageLog` ثبت می‌شوند و وضعیت صف در جدول `NotificationJob` نگه‌داری می‌شود.

## اجرای دستی کران اعلان‌ها
- مسیر داخلی: `POST /api/internal/cron/notifications`
- هدر لازم: `x-cron-secret: <CRON_SECRET>`
- خروجی JSON شامل تعداد یادآوری‌های صف‌شده و پیام‌های پردازش‌شده است.
- برای تکرار در محیط توسعه می‌توانید از دستور زیر استفاده کنید:

```bash
curl -X POST \
  -H "x-cron-secret: $CRON_SECRET" \
  http://localhost:3000/api/internal/cron/notifications
```

این کران هم یادآوری‌های سه‌روز-مانده را صف می‌کند و هم دسته‌ای از جاب‌های منتظر را اجرا می‌کند.

## بازپخش ایمن رویدادها
1. شناسه مورد نظر (پرداخت، فاکتور یا اشتراک) را از جدول مربوطه بیابید.
2. ورودی متناظر در جدول `NotificationMessageLog` را پیدا کنید و مقدار `dedupeKey` را بررسی کنید.
3. برای ارسال مجدد، ابتدا رکوردهای `NotificationJob` مرتبط با `logId` را حذف و سپس رکورد `NotificationMessageLog` را پاک کنید. این کار به شما امکان می‌دهد رویداد را دوباره منتشر کنید.
4. رویداد دامنه را با استفاده از اسکریپت `tsx` یا کنسول Prisma اجرا کنید (برای نمونه `emitBillingSubscriptionRenewed`).

> **نکته:** همیشه قبل از بازپخش، اطمینان حاصل کنید که کاربر، اولویت اعلان را غیرفعال نکرده باشد.

## بررسی صف و وضعیت‌ها
- جدول `NotificationMessageLog`: وضعیت نهایی (Queued/Sent/Failed/Skipped)، خطا و شناسه پیام ارائه‌دهنده.
- جدول `NotificationJob`: تلاش‌های انجام‌شده، `runAt` بعدی و وضعیت پردازش.
- جدول `Notification`: اعلان‌های درون‌برنامه تحویل داده‌شده.

از صفحه‌ی ادمین `مدیریت > صورتحساب > اعلان‌ها` برای مشاهده‌ی رابط کاربری این داده‌ها استفاده کنید. می‌توانید بر اساس وضعیت، کانال، نوع رویداد و تاریخ فیلتر کنید.

## غیرفعال کردن موقت یادآوری‌ها
- برای خاموش کردن یادآوری‌های سه‌روز-مانده، مقدار متغیر `NOTIFICATIONS_REMINDERS_ENABLED=0` را در پیکربندی کران/ورکر ست کنید. (اگر تعریف نشده است، می‌توانید هنگام اجرای کران آن را بررسی کرده و از اجرای `queueSubscriptionExpiryReminders` صرف‌نظر کنید.)
- برای جلوگیری از ارسال ایمیل‌ها در محیط QA، مقدار `NOTIFICATIONS_DELIVERY_MODE=inline` را تنظیم کنید تا جاب‌ها بلافاصله پردازش شده و فقط در Mailhog ظاهر شوند.

## اولویت‌ها و لینک مدیریت
- هر ایمیل حاوی لینک مدیریت با امضای HMAC است که از `NOTIFICATIONS_SECRET` استفاده می‌کند.
- برای بی‌اعتبار کردن یک لینک، مقدار `NOTIFICATIONS_SECRET` را تغییر دهید یا رکوردهای `NotificationPreference` کاربر را به‌روزرسانی کنید.

## پایش و مشاهده‌پذیری
- لاگ‌های کنسول با پیشوند `[notifications]` وضعیت ارسال‌ها، خطاها و تلاش‌های مجدد را نشان می‌دهند.
- برای مشاهده‌ی پیام‌های خطا به ستون `error` در صفحه‌ی ادمین یا جدول `NotificationMessageLog` مراجعه کنید.
- برای مانیتورینگ خارجی می‌توانید یک مشاهده‌گر سفارشی با `setNotificationDispatchObserver` ثبت کنید تا رویدادهای صف را به سامانه‌ی متریک ارسال کند.

## رفع خطاهای رایج
| خطا | علت محتمل | راهکار |
| --- | --- | --- |
| `NOTIFICATIONS_SECRET missing` | متغیر محیطی تنظیم نشده است | مقدار را در `.env` یا پیکربندی دیپلوی ست کنید. |
| `EMAIL_TEMPLATE_MISSING` | محتویات ایمیل برای کانال ایمیل ارسال نشده | قالب اعلان را بررسی کنید و مقدار `emailContent` را تامین کنید. |
| تلاش‌های بیش از حد برای ایمیل | سرویس ارسال ایمیل در دسترس نیست | صف را مانیتور کنید؛ پس از رفع خطا، کران `processDueJobs` را دوباره اجرا کنید. |

## تست سریع تولید
1. پیام جدیدی (مثلاً تمدید موفق) را در محیط سنباکس ایجاد کنید.
2. صفحه ادمین اعلان‌ها را بررسی کنید تا رکورد جدید با وضعیت `SENT` دیده شود.
3. ایمیل متناظر را در Mailhog (یا اینباکس واقعی) بررسی کنید.
4. اگر کاربر اعلان ایمیل را غیرفعال کرده بود، وضعیت باید `SKIPPED` باشد.
