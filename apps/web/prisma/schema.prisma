generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  name             String?
  passwordHash     String?
  role             Role              @default(USER)
  createdAt        DateTime          @default(now())
  checkoutSessions CheckoutSession[]
  invoices         Invoice[]
  payments         Payment[]
  entitlements     UserEntitlement[]
  profile          Profile?
  moderatedProfiles Profile[]        @relation("ProfileModerators")
  moderationEvents  ModerationEvent[] @relation("ModerationActor")
  notifications    Notification[]
  emailLogs        EmailLog[]
}

model Profile {
  id          String             @id @default(cuid())
  userId      String             @unique
  user        User               @relation(fields: [userId], references: [id])

  firstName   String?
  lastName    String?
  stageName   String?
  age         Int?
  phone       String?
  address     String?
  cityId      String?

  avatarUrl   String?
  bio         String?
  gallery     Json?

  skills      Json?
  socialLinks Json?

  visibility  ProfileVisibility  @default(PRIVATE)
  publishedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  moderationStatus ModerationStatus @default(PENDING)
  moderationNotes  String?
  moderatedBy      String?
  moderatedAt      DateTime?
  moderator        User?             @relation("ProfileModerators", fields: [moderatedBy], references: [id])
  moderationEvents ModerationEvent[]

  @@index([visibility])
  @@index([moderationStatus])
  @@index([updatedAt])
}

model ModerationEvent {
  id        String            @id @default(cuid())
  profileId String
  profile   Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)
  actorId   String?
  actor     User?             @relation("ModerationActor", fields: [actorId], references: [id])
  action    ModerationAction
  reason    String?
  createdAt DateTime          @default(now())

  @@index([profileId, createdAt])
}

model Product {
  id        String      @id @default(cuid())
  type      ProductType
  name      String
  active    Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  plans     Plan[]
  prices    Price[]
}

model Plan {
  id        String    @id @default(cuid())
  productId String
  name      String
  cycle     PlanCycle
  limits    Json
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  product   Product   @relation(fields: [productId], references: [id])
  prices    Price[]

  @@index([productId, active])
}

model Price {
  id        String            @id @default(cuid())
  currency  String            @default("IRR")
  amount    Int
  active    Boolean           @default(true)
  planId    String?
  productId String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  sessions  CheckoutSession[]
  plan      Plan?             @relation(fields: [planId], references: [id], onDelete: Restrict)
  product   Product?          @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([planId, active])
  @@index([productId, active])
}

model CheckoutSession {
  id                      String         @id @default(cuid())
  userId                  String
  provider                Provider
  priceId                 String
  status                  CheckoutStatus @default(STARTED)
  redirectUrl             String
  returnUrl               String
  providerInitPayload     Json
  providerCallbackPayload Json?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  price                   Price          @relation(fields: [priceId], references: [id])
  user                    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments                Payment[]

  @@index([userId, status])
}

model Payment {
  id                String          @id @default(cuid())
  userId            String
  checkoutSessionId String
  provider          Provider
  providerRef       String
  amount            Int
  currency          String          @default("IRR")
  status            PaymentStatus
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  invoice           Invoice?
  session           CheckoutSession @relation(fields: [checkoutSessionId], references: [id], onDelete: Cascade)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerRef])
}

model Invoice {
  id        String        @id @default(cuid())
  userId    String
  paymentId String        @unique
  total     Int
  currency  String        @default("IRR")
  status    InvoiceStatus
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  payment   Payment       @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserEntitlement {
  id               String         @id @default(cuid())
  userId           String
  key              EntitlementKey
  expiresAt        DateTime?
  remainingCredits Int?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([userId, key, expiresAt])
}

enum ProductType {
  SUBSCRIPTION
  JOB_POST
}

enum PlanCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum Provider {
  zarinpal
  idpay
  nextpay
}

enum CheckoutStatus {
  STARTED
  PENDING
  SUCCESS
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
}

enum Role {
  USER
  ADMIN
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ModerationAction {
  APPROVE
  REJECT
  REVERT_TO_PENDING
  HIDE
  UNHIDE
  SYSTEM_AUTO_UNPUBLISH
}

enum InvoiceStatus {
  OPEN
  PAID
  VOID
}

enum EntitlementKey {
  CAN_PUBLISH_PROFILE
  JOB_POST_CREDIT
}

enum NotificationChannel {
  IN_APP
  EMAIL
}

enum NotificationType {
  MODERATION_APPROVED
  MODERATION_REJECTED
  MODERATION_PENDING
  MODERATION_HIDDEN
  MODERATION_UNHIDDEN
  SYSTEM_AUTO_UNPUBLISH
  USER_PUBLISH_SUBMITTED
  USER_UNPUBLISHED
  ENTITLEMENT_EXPIRED
  ENTITLEMENT_RESTORED
}

model Notification {
  id        String              @id @default(cuid())
  userId    String              @index
  type      NotificationType
  title     String
  body      String
  payload   Json?
  channel   NotificationChannel @default(IN_APP)
  readAt    DateTime?
  createdAt DateTime            @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, readAt])
}

model EmailLog {
  id        String   @id @default(cuid())
  userId    String   @index
  to        String
  subject   String
  status    String
  error     String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
