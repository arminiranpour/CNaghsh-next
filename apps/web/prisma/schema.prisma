generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  createdAt               DateTime                 @default(now())
  name                    String?
  passwordHash            String?
  role                    Role                     @default(USER)
  timezone                String?                  @db.VarChar(64)
  checkoutSessions        CheckoutSession[]
  emailLogs               EmailLog[]
  invoices                Invoice[]
  Job                     Job[]
  jobModerationEvents     JobModerationEvent[]     @relation("JobModerationAdmin")
  moderationEvents        ModerationEvent[]        @relation("ModerationActor")
  notifications           Notification[]
  payments                Payment[]
  jobCreditGrants         JobCreditGrant[]
  subscriptions           Subscription[]
  moderatedProfiles       Profile[]                @relation("ProfileModerators")
  profile                 Profile?
  entitlements            UserEntitlement[]
  auditLogs               AuditLog[]
  notificationPreferences NotificationPreference[]
  notificationMessageLogs NotificationMessageLog[]
  mediaAssets             MediaAsset[]
  mediaModerationReviews  MediaAsset[]             @relation("MediaModerationReviewer")
  applications            Application[]            @relation("ApplicantApplications")
  applicationEvents       ApplicationEvent[]       @relation("ApplicationEventActor")
  applicationViews        ApplicationView[]        @relation("ApplicationViewViewer")
}

model Profile {
  id                String            @id @default(cuid())
  userId            String            @unique
  firstName         String?
  lastName          String?
  stageName         String?
  age               Int?
  birthDate         DateTime?
  gender            Gender?
  educationLevel    EducationLevel?
  phone             String?
  address           String?
  cityId            String?
  avatarUrl         String?
  bio               String?
  introVideoMediaId String?
  gallery           Json?
  videos            Json?
  skills            Json?
  languages         Json?
  accents           Json?
  experience        Json?
  degrees           Json?
  voices            Json?
  awards            ProfileAward[]
  socialLinks       Json?
  visibility        ProfileVisibility @default(PRIVATE)
  publishedAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  moderationStatus  ModerationStatus  @default(PENDING)
  moderationNotes   String?
  moderatedBy       String?
  moderatedAt       DateTime?
  moderationEvents  ModerationEvent[]
  introVideoMedia   MediaAsset?       @relation("ProfileIntroVideo", fields: [introVideoMediaId], references: [id], onDelete: SetNull)
  moderator         User?             @relation("ProfileModerators", fields: [moderatedBy], references: [id])
  user              User              @relation(fields: [userId], references: [id])

  @@index([visibility])
  @@index([moderationStatus])
  @@index([updatedAt])
  @@index([introVideoMediaId])
  @@index([birthDate])
  @@index([gender])
  @@index([educationLevel])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum EducationLevel {
  DIPLOMA
  ASSOCIATE
  BACHELOR
  MASTER
  PHD
  OTHER
}

model ProfileAward {
  id        String   @id @default(cuid())
  profileId String
  title     String
  place     String?
  awardDate String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, awardDate])
}

// After updating the schema, run:
// pnpm prisma migrate dev --name add-profile-videos
// pnpm prisma generate

model ModerationEvent {
  id        String           @id @default(cuid())
  profileId String
  actorId   String?
  action    ModerationAction
  reason    String?
  createdAt DateTime         @default(now())
  actor     User?            @relation("ModerationActor", fields: [actorId], references: [id])
  profile   Profile          @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, createdAt])
}

model Product {
  id        String      @id @default(cuid())
  type      ProductType
  name      String
  active    Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  plans     Plan[]
  prices    Price[]
}

model Plan {
  id            String         @id @default(cuid())
  productId     String
  name          String
  cycle         PlanCycle
  limits        Json
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  product       Product        @relation(fields: [productId], references: [id])
  prices        Price[]
  subscriptions Subscription[]

  @@index([productId, active])
}

model Price {
  id        String            @id @default(cuid())
  currency  String            @default("IRR")
  amount    Int
  active    Boolean           @default(true)
  planId    String?
  productId String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  sessions  CheckoutSession[]
  plan      Plan?             @relation(fields: [planId], references: [id], onDelete: Restrict)
  product   Product?          @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([planId, active])
  @@index([productId, active])
}

model CheckoutSession {
  id                      String         @id @default(cuid())
  userId                  String
  provider                Provider
  priceId                 String
  status                  CheckoutStatus @default(STARTED)
  redirectUrl             String
  returnUrl               String
  providerInitPayload     Json
  providerCallbackPayload Json?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  price                   Price          @relation(fields: [priceId], references: [id])
  user                    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments                Payment[]

  @@index([userId, status])
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String
  planId            String
  status            SubscriptionStatus @default(active)
  startedAt         DateTime           @default(now())
  endsAt            DateTime
  renewalAt         DateTime?
  cancelAtPeriodEnd Boolean            @default(false)
  providerRef       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  plan              Plan               @relation(fields: [planId], references: [id], onDelete: Restrict)
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([status])
  @@index([endsAt])
  @@index([planId])
  @@index([providerRef])
  @@index([createdAt])
}

model Payment {
  id                String              @id @default(cuid())
  userId            String
  checkoutSessionId String
  provider          Provider
  providerRef       String
  amount            Int
  currency          String              @default("IRR")
  status            PaymentStatus
  refundedAmount    Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  invoice           Invoice?
  session           CheckoutSession     @relation(fields: [checkoutSessionId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  webhookLogs       PaymentWebhookLog[]
  jobCreditGrants   JobCreditGrant[]

  @@unique([provider, providerRef])
  @@index([status])
  @@index([provider])
  @@index([createdAt])
  @@index([amount])
}

model PaymentWebhookLog {
  id         String    @id @default(cuid())
  provider   String
  eventType  String?
  externalId String
  signature  String?
  payload    Json
  receivedAt DateTime  @default(now())
  handledAt  DateTime?
  status     String?
  paymentId  String?
  payment    Payment?  @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@unique([provider, externalId])
  @@index([receivedAt])
  @@index([status])
  @@index([provider])
  @@index([paymentId])
}

model Invoice {
  id               String        @id @default(cuid())
  userId           String
  paymentId        String?       @unique
  number           String?       @unique
  type             InvoiceType   @default(SALE)
  providerRef      String?
  issuedAt         DateTime      @default(now())
  total            Int
  currency         String        @default("IRR")
  status           InvoiceStatus
  planId           String?
  planName         String?
  planCycle        PlanCycle?
  periodStart      DateTime?
  periodEnd        DateTime?
  unitAmount       Int?
  quantity         Int?          @default(1)
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  payment          Payment?      @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  relatedInvoiceId String?
  relatedInvoice   Invoice?      @relation("InvoiceRelations", fields: [relatedInvoiceId], references: [id], onDelete: SetNull)
  refunds          Invoice[]     @relation("InvoiceRelations")

  @@index([userId])
  @@index([issuedAt])
  @@index([paymentId])
  @@index([status])
  @@index([type])
}

model InvoiceSequence {
  sequenceDate DateTime @id
  counter      Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model UserEntitlement {
  id               String         @id @default(cuid())
  userId           String
  key              EntitlementKey
  expiresAt        DateTime?
  remainingCredits Int?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// NOTE: Prisma does not support partial indexes.
  /// Application logic ensures at most one active CAN_PUBLISH_PROFILE entitlement per user.
  @@unique([userId, key, expiresAt])
  @@index([userId, key])
  @@index([expiresAt])
  @@index([createdAt])
}

model JobCreditGrant {
  id        String   @id @default(cuid())
  userId    String
  paymentId String   @unique
  credits   Int
  reason    String   @default("JOB_CREDIT_PURCHASE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model AuditLog {
  id             String   @id @default(cuid())
  actorId        String
  actorEmail     String?
  resourceType   String
  resourceId     String
  action         String
  reason         String
  before         Json?
  after          Json?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  idempotencyKey String?  @unique
  createdAt      DateTime @default(now())

  actor User @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([resourceType, resourceId, createdAt])
  @@index([actorId, createdAt])
  @@index([createdAt])
}

model Job {
  id                String               @id @default(cuid())
  userId            String
  title             String               @db.VarChar(140)
  description       String
  category          String               @db.VarChar(64)
  cityId            String?              @db.VarChar(64)
  payType           String?              @db.VarChar(32)
  payAmount         Int?
  currency          String?              @db.VarChar(3)
  remote            Boolean              @default(false)
  status            JobStatus            @default(DRAFT)
  moderation        JobModeration        @default(PENDING)
  introVideoMediaId String?
  featuredUntil     DateTime?
  views             Int                  @default(0)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  moderationEvents  JobModerationEvent[]
  introVideoMedia   MediaAsset?          @relation("JobIntroVideo", fields: [introVideoMediaId], references: [id], onDelete: SetNull)
  applications      Application[]

  @@index([status, moderation, featuredUntil])
  @@index([category])
  @@index([cityId])
  @@index([title])
  @@index([introVideoMediaId])
}

model JobModerationEvent {
  id        String         @id @default(cuid())
  jobId     String
  adminId   String
  action    JobAdminAction
  note      String?
  createdAt DateTime       @default(now())
  admin     User           @relation("JobModerationAdmin", fields: [adminId], references: [id])
  job       Job            @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, createdAt])
  @@index([adminId])
}

model Notification {
  id        String              @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  payload   Json?
  channel   NotificationChannel @default(IN_APP)
  readAt    DateTime?
  createdAt DateTime            @default(now())
  dedupeKey String?             @db.VarChar(255)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dedupeKey])
  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, readAt])
  @@index([dedupeKey])
}

model EmailLog {
  id        String   @id @default(cuid())
  userId    String
  to        String
  subject   String
  status    String
  error     String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationPreference {
  id           String               @id @default(cuid())
  userId       String
  category     NotificationCategory
  emailEnabled Boolean              @default(true)
  inAppEnabled Boolean              @default(true)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@index([category])
}

model NotificationMessageLog {
  id                String                     @id @default(cuid())
  userId            String?
  email             String?
  eventType         String
  channel           NotificationChannel
  dedupeKey         String                     @db.VarChar(255)
  status            NotificationDispatchStatus
  attempts          Int                        @default(0)
  providerMessageId String?
  error             String?
  metadata          Json?
  lastAttemptAt     DateTime?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  user              User?                      @relation(fields: [userId], references: [id], onDelete: SetNull)
  jobs              NotificationJob[]

  @@unique([dedupeKey, channel])
  @@index([userId])
  @@index([channel])
}

model NotificationJob {
  id          String                 @id @default(cuid())
  logId       String
  status      NotificationJobStatus  @default(PENDING)
  attempts    Int                    @default(0)
  maxAttempts Int                    @default(3)
  runAt       DateTime               @default(now())
  payload     Json
  error       String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  messageLog  NotificationMessageLog @relation(fields: [logId], references: [id], onDelete: Cascade)

  @@index([status, runAt])
}

model MediaAsset {
  id                      String                @id @default(cuid())
  type                    MediaType
  status                  MediaStatus           @default(uploaded)
  visibility              MediaVisibility       @default(private)
  ownerUserId             String
  sourceKey               String
  outputKey               String?               @unique
  posterKey               String?
  durationSec             Int?
  width                   Int?
  height                  Int?
  codec                   String?
  bitrate                 Int?
  sizeBytes               BigInt?
  errorMessage            String?
  moderationStatus        MediaModerationStatus @default(pending)
  moderationReason        String?
  moderationReviewedAt    DateTime?
  moderationReviewedById  String?
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  owner                   User                  @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  moderationReviewedBy    User?                 @relation("MediaModerationReviewer", fields: [moderationReviewedById], references: [id])
  transcodeJobs           TranscodeJob[]
  profileIntroVideoUsages Profile[]             @relation("ProfileIntroVideo")
  jobIntroVideoUsages     Job[]                 @relation("JobIntroVideo")

  @@index([ownerUserId, type, status])
  @@index([createdAt])
  @@index([moderationStatus])
}

model TranscodeJob {
  id           String             @id @default(cuid())
  mediaAssetId String
  attempt      Int                @default(1)
  status       TranscodeJobStatus @default(queued)
  startedAt    DateTime?
  finishedAt   DateTime?
  logs         Json?
  createdAt    DateTime           @default(now())
  mediaAsset   MediaAsset         @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId, createdAt])
  @@index([status])
}

model Application {
  id              String             @id @default(cuid())
  jobId           String
  applicantUserId String
  coverNote       String?            @db.Text
  status          ApplicationStatus  @default(new)
  attachments     Json?
  consents        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  deletedAt       DateTime?
  job             Job                @relation(fields: [jobId], references: [id], onDelete: Restrict)
  applicant       User               @relation("ApplicantApplications", fields: [applicantUserId], references: [id], onDelete: Restrict)
  events          ApplicationEvent[]
  views           ApplicationView[]

  @@unique([jobId, applicantUserId])
  @@index([jobId, status], name: "idx_app_job_status")
  @@index([applicantUserId, createdAt(sort: Desc)], name: "idx_app_applicant")
  @@index([createdAt(sort: Desc)], name: "idx_app_created")
}

model ApplicationEvent {
  id            String               @id @default(cuid())
  applicationId String
  actorUserId   String?
  type          ApplicationEventType
  payload       Json
  createdAt     DateTime             @default(now())
  application   Application          @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  actor         User?                @relation("ApplicationEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([applicationId, createdAt], name: "idx_appevt_app_created")
}

model ApplicationView {
  id            String      @id @default(cuid())
  applicationId String
  viewerUserId  String?
  ipHash        String?
  userAgentHash String?
  createdAt     DateTime    @default(now())
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  viewer        User?       @relation("ApplicationViewViewer", fields: [viewerUserId], references: [id], onDelete: SetNull)

  @@index([applicationId, createdAt])
}

enum ProductType {
  SUBSCRIPTION
  JOB_POST
}

enum PlanCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum Provider {
  zarinpal
  idpay
  nextpay
}

enum SubscriptionStatus {
  active
  expired
  canceled
  renewing
}

enum CheckoutStatus {
  STARTED
  PENDING
  SUCCESS
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  REFUNDED_PARTIAL
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
}

enum Role {
  USER
  ADMIN
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ModerationAction {
  APPROVE
  REJECT
  REVERT_TO_PENDING
  HIDE
  UNHIDE
  SYSTEM_AUTO_UNPUBLISH
}

enum InvoiceStatus {
  DRAFT
  PAID
  VOID
  REFUNDED
}

enum InvoiceType {
  SALE
  REFUND
}

enum EntitlementKey {
  CAN_PUBLISH_PROFILE
  JOB_POST_CREDIT
}

enum NotificationChannel {
  IN_APP
  EMAIL
}

enum NotificationCategory {
  BILLING_TRANSACTIONAL
  BILLING_REMINDERS
}

enum NotificationType {
  MODERATION_APPROVED
  MODERATION_REJECTED
  MODERATION_PENDING
  MODERATION_HIDDEN
  MODERATION_UNHIDDEN
  SYSTEM_AUTO_UNPUBLISH
  USER_PUBLISH_SUBMITTED
  USER_UNPUBLISHED
  ENTITLEMENT_EXPIRED
  ENTITLEMENT_RESTORED
  BILLING_REFUND_ISSUED
  BILLING_CANCEL_IMMEDIATE
  BILLING_CANCEL_SCHEDULED
  BILLING_SUBSCRIPTION_RENEWED
  BILLING_SUBSCRIPTION_EXPIRY_REMINDER
  BILLING_SUBSCRIPTION_EXPIRED
  BILLING_PAYMENT_FAILED
  BILLING_INVOICE_READY
  BILLING_INVOICE_REFUND_READY
  BILLING_WEBHOOK_ALERT
}

enum NotificationDispatchStatus {
  QUEUED
  SENT
  FAILED
  SKIPPED
}

enum NotificationJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum MediaType {
  image
  video
  audio
}

enum MediaStatus {
  uploaded
  processing
  ready
  failed
}

enum MediaVisibility {
  public
  private
}

enum MediaModerationStatus {
  pending
  approved
  rejected
}

enum TranscodeJobStatus {
  queued
  processing
  done
  failed
}

enum ApplicationStatus {
  new
  shortlist
  reject
  select
  withdrawn
}

enum ApplicationEventType {
  status_change
  note
  system
  attachment_add
  attachment_remove
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum JobModeration {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum JobAdminAction {
  APPROVE
  REJECT
  SUSPEND
  FEATURE
  UNFEATURE
  CLOSE
}
